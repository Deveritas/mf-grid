!function(){function a(){var a=document.createElement("p");a.style.width="100%",a.style.height="200px";var b=document.createElement("div");b.style.position="absolute",b.style.top="0px",b.style.left="0px",b.style.visibility="hidden",b.style.width="200px",b.style.height="150px",b.style.overflow="hidden",b.appendChild(a),document.body.appendChild(b);var c=a.offsetWidth;b.style.overflow="scroll";var d=a.offsetWidth;return c===d&&(d=b.clientWidth),document.body.removeChild(b),c-d}function b(a,b){var c=b||"12px arial",d=$("<div>"+a+"</div>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden",font:c}).appendTo($("body")),e=d.width();return d.remove(),e}var c='<div class="grid-container" ng-show="grid._data && grid._data.length"><div class="grid-header"><table class="grid-header-content-wrapper table"><thead class="grid-header-content"></thead></table></div><div class="grid-body overthrow"><div class="grid-body-viewport-content"><table class="grid-body-content-wrapper table"><tbody class="grid-body-content"></tbody></table></div></div></div>',d='<tr class="grid-row"><th ng-if="grid.showSelectionCheckbox" class="grid-column grid-checkbox-column"><input ng-if="grid.multiSelect" ng-checked="grid.allItemsSelected" title="Select All" type="checkbox" class="check-all" /></th><th ng-repeat="column in grid.enabledColumns" ng-style="{ width: column.width }" ng-class="{ \'grid-column-sortable\': grid.enableSorting }" ng-click="headerColumnClick(column, $index)" class="grid-column {{ column.headerClass }}">{{ column.displayName }}<div ng-show="grid.enableSorting && grid.sortColumn && grid.sortColumn.field === column.field"'+" class=\"grid-sort-icon glyphicon glyphicon-chevron-{{ grid.sortAsc ? 'up' : 'down' }} icon-chevron-{{ grid.sortAsc ? 'up' : 'down' }}\"></div></th></tr>",e='<tr mf-grid-row ng-repeat="item in grid.visibleItems track by $index" ng-class="rowClass" class="grid-row"><td ng-if="grid.showSelectionCheckbox" class="grid-column grid-checkbox-column"><input ng-checked="isSelected" type="checkbox" /></td><td mf-grid-column ng-repeat="column in grid.enabledColumns" class="grid-column"></td></tr>';jQuery.fn.isAutoHeight=function(){var a=this.height(),b=$("<div></div>").css({clear:"both",height:a+10}).appendTo(this),c=this.height();return b.remove(),c>a},Array.prototype.remove=Array.prototype.remove||function(a,b){var c=this.slice((b||a)+1||this.length);return this.length=0>a?this.length+a:a,this.push.apply(this,c)};var f={};f.guessSortFn=function(a){var b=typeof a;switch(b){case"number":return f.sortNumber;case"boolean":return f.sortBool;case"string":return a.match(/^[-+]?[£$¤]?[\d,.]+%?$/)?f.sortNumberStr:f.sortAlpha;default:return"[object Date]"===Object.prototype.toString.call(a)?f.sortDate:f.basicSort}},f.basicSort=function(a,b){return a===b?0:b>a?-1:1},f.sortNumber=function(a,b){return a-b},f.sortNumberStr=function(a,b){var c,d,e=!1,f=!1;return c=parseFloat(a.replace(/[^0-9.-]/g,"")),isNaN(c)&&(e=!0),d=parseFloat(b.replace(/[^0-9.-]/g,"")),isNaN(d)&&(f=!0),e&&f?0:e?1:f?-1:c-d},f.sortAlpha=function(a,b){var c=a.toLowerCase(),d=b.toLowerCase();return c===d?0:d>c?-1:1},f.sortDate=function(a,b){var c=a.getTime(),d=b.getTime();return c===d?0:d>c?-1:1},f.sortBool=function(a,b){return a&&b?0:a||b?a?1:-1:0};var g=1,h=function(a){this.id=g,g++,this.$parse=a,this._data=[],this.enabledColumns=[],this.selectedItems=[],this.visibleItems=[],this.columnDefs=[]};h.prototype={_data:null,columnDefs:null,showSelectionCheckbox:!1,enabledColumns:null,selectedItems:null,multiSelect:!0,allItemsSelected:!1,trackItemBy:null,$parse:null,visibleItems:null,virtualizationThreshold:50,virtualizationOverflow:3,itemsBefore:0,pixelsBefore:0,height:null,viewportHeight:0,headerRowHeight:0,enableSorting:!0,rowHeight:30,scrollTop:0,sortColumn:null,_prevSortColumn:null,_prevSortAsc:!1,sortAsc:!0,_oldLength:0,headerColumnClick:null,rowClick:null,sortByColumn:function(a,b){if(this._prevSortColumn===a){if(this._prevSortAsc===b)return;return this._prevSortAsc=b,this._data.reverse(),void 0}this._prevSortAsc=b,this._prevSortColumn=this.sortColumn=a;var c=a.sortFn;this._data.sort(function(b,d){b=a.getRawValue(b),d=a.getRawValue(d);var e="undefined"!=typeof b&&null!==b,g="undefined"!=typeof d&&null!==d;return e||g?e&&!g?-1:!e&&g?1:("undefined"==typeof c&&(c=f.guessSortFn(b)),c(b,d)):0})},isColumnSortable:function(a){return this.enableSorting&&a.sortable},setViewportHeight:function(a){this.viewportHeight=a,this.updateVisibleItems()},setScrollTop:function(a){this.scrollTop=a,this.updateVisibleItems()},updateVisibleItems:function(){var a=this.rowHeight,b=this.viewportHeight,c=this._data.length,d=Math.ceil(b/a);if(this.totalHeight=c*a,this.itemsBefore=this.pixelsBefore=0,d>=c||c<=this.virtualizationThreshold)return this.visibleItems=this._data,void 0;var e=this.virtualizationOverflow,f=Math.max(this.scrollTop,0),g=~~(f/a),h=Math.min(e,g);this.itemsBefore=g-h,this.pixelsBefore=this.itemsBefore*a;var i=Math.min(this.itemsBefore+d+(e+h),c);this.visibleItems=this._data.slice(this.itemsBefore,i)},isItemSelected:function(a){return-1!==this.selectedItems.indexOf(a)},updateCheckAll:function(){if(this.multiSelect===!1&&this.selectedItems.length>1){var a=this.selectedItems[this.selectedItems.length-1];this.selectedItems.length=1,this.selectedItems[0]=a}this.allItemsSelected=this._data.length===this.selectedItems.length},selectItem:function(a,b){if(this.multiSelect===!1)return this.selectedItems.length=0,this.selectedItems.push(a),this.updateCheckAll(),void 0;var c=this.selectedItems.indexOf(a),d=-1!==c;b&&d||!b&&!d||(b?this.selectedItems.push(a):this.selectedItems.remove(c),this.updateCheckAll())},selectAll:function(a){if(!a)return this.allItemsSelected=!1,this.selectedItems.length=0,void 0;for(var b=0,c=this._data.length;c>b;++b)this.selectedItems.push(this._data[b]);this.allItemsSelected=!0},buildColumn:function(a){function c(b){return a.isScopeKey===!0?!0:"undefined"==typeof b?!1:(("undefined"!=typeof b[a.field]||b.hasOwnProperty(a.field))&&(a.isScopeKey=!0),a.isScopeKey||!1)}function d(b){return a.isItemKey===!0?!0:"undefined"==typeof b?!1:(("undefined"!=typeof b[a.field]||b.hasOwnProperty(a.field))&&(a.isItemKey=!0),a.isItemKey||!1)}function e(){return"string"==typeof a.cellFilter&&a.cellFilter.length>0}var f=this;"string"==typeof a&&(a={field:a}),"undefined"==typeof a.displayName&&(a.displayName=a.field),"undefined"==typeof a.visible&&(a.visible=!0),"undefined"==typeof a.sortable&&(a.sortable=!0);var g;a.getRawValue=function(a,b){return d(a)?a[this.field]:(b=b||f.$scope||{},c(b)?b[this.field]:("function"!=typeof g&&(g=f.$parse(this.field)),g(b,a)))};var h;if(a.getFilteredValue=function(a,b){return e()?("function"!=typeof h&&(h=f.$parse(this.field+" | "+this.cellFilter)),h(b||f.$scope||{},a)):this.getRawValue(a,b)},a.getLongestValue=function(){if(!f._data||!f._data.length)return null;for(var a=this.displayName,b=0,c=Math.min(f._data.length,50);c>b;++b){var d=f._data[b],e=this.getFilteredValue(d);if(null!==e&&"undefined"!=typeof e&&"undefined"!=typeof e.toString){var g=e.toString();g.length>a.length&&(a=g)}}return a},"undefined"==typeof a.width||"auto"===a.width){var i=a.getLongestValue();if(null!==i&&i.length>0){var j=$("table.grid-body-content-wrapper").css("font");a.width=b(i,j)+28+"px"}else a.width="50px"}return a},setColumns:function(a){if(this.enabledColumns=[],a&&a.length)for(var b=0,c=a.length;c>b;++b){var d=this.buildColumn(a[b]);d.visible&&this.enabledColumns.push(d)}else if(this._data.length>0)for(var e in this._data[0])this.enabledColumns.push(this.buildColumn(e))},setData:function(a){var b=this._data!==a||this._oldLength!==a.length;(null===a||"undefined"==typeof a)&&(a=[]),this._data=a,this._oldLength=a.length;for(var c=[],d=0,e=this.selectedItems.length;e>d;++d){var f=this.selectedItems[d];if(-1===a.indexOf(f)){if(null!==this.trackItemBy&&"string"==typeof this.trackItemBy&&"undefined"!=typeof f[this.trackItemBy])for(var g=0,h=a.length;h>g;++g){var i=a[g];if(null!==i&&"undefined"!=typeof i&&f[this.trackItemBy]===i[this.trackItemBy]){c.push(i);break}}}else c.push(f)}this.selectedItems=c,this.updateCheckAll(),this.setColumns(this.columnDefs),b&&"function"!=typeof this.headerColumnClick&&this.sortColumn&&this.sortByColumn(this.sortColumn,this.sortAsc),this.updateVisibleItems()}},angular.module("mfGrid",[]).controller("MfGridCtrl",["$parse",function(a){return new h(a)}]).directive("mfGrid",["$http","$templateCache","$compile","$parse","$timeout","$window",function(b,f,g,h,i,j){function k(c,k,l,m){function n(){var b=parseInt(m.headerRowHeight,10)||0,d=t.find(".grid-row");k.isAutoHeight()?(B=window,v.css("position","static")):(B=w,v.css({position:"absolute",top:0,bottom:0,left:0,right:0})),0!==d.length?(d[0].style.height=b+"px",w.style.marginTop=t[0].offsetHeight||b+"px"):w.style.marginTop=b+"px",c.scrollbarWidth=w.scrollHeight>w.offsetHeight?a():0;var e;if(B===window){e=$(window).height();var f=k.offset().top-window.scrollY;f>0&&(e-=f)}else e=w.offsetHeight;m.setViewportHeight(e)}function o(){n(),c.$digest()}function p(){if(t[0].scrollLeft=w.scrollLeft,B===w){var a=w.scrollTop,b=1,d=D-m.rowHeight*b,e=D+m.rowHeight*b;a>=d&&e>=a||(D=a,m.setScrollTop(a),y[0].style.top=m.pixelsBefore+"px",c.$digest())}}function q(){if(B===window){var a=Math.max(0,window.scrollY-k.offset().top),b=1,d=D-m.rowHeight*b,e=D+m.rowHeight*b;a>=d&&e>=a||(D=a,m.setScrollTop(a),y[0].style.top=m.pixelsBefore+"px",c.$digest())}}function r(a){var b=a.closest(".grid-row").scope();if(b)return b.item}function s(a,b){a.html(b),g(a.contents())(c)}var t=k.find(".grid-header"),u=t.find(".grid-header-content"),v=k.find(".grid-body"),w=v[0],x=k.find(".grid-body-viewport-content"),y=v.find(".grid-body-content-wrapper"),z=v.find(".grid-body-content"),A=h(m.data),B=window;if(!w)throw new Error(".grid-body not found.");m.rowHeight=parseInt(m.rowHeight,10)||50,c.$watchCollection(function(){return A(c.$parent)},function(a){m.setData(a),n()}),c.$watchCollection("grid.columnDefs",function(a){m.setColumns(a)}),c.$watchCollection("grid.selectedItems",function(){m.updateCheckAll(),m.selectionChanged&&m.selectionChanged(m.selectedItems)}),c.$watch("grid.multiSelect",function(){m.updateCheckAll()}),c.$watch(function(){return B.offsetHeight},n);var C=angular.element(j);C.on("resize",o),C.on("scroll",q),c.$on("$destroy",function(){m.id;try{C.off("resize",o),C.off("scroll",q)}catch(a){}c.headerColumnClick=null,m._data=null,m.selectedItems=null,m.visibleItems=null,m.columnDefs=null,m.enabledColumns=null,m.$parse=null,m.$scope=null,m=null,c.grid=null,k=null,t=null,u=null,v=null,w=null,x=null,y=null,z=null,c=null}),c.$watch("grid.height",function(a){"undefined"!=typeof a&&""!==a&&null!==a&&k.css("height",a),i(function(){n()})}),c.$watch("grid.scrollbarWidth",function(a){"undefined"!=typeof a&&null!==a&&t.css("margin-right",a+"px")}),c.$watch("grid.totalHeight",function(a){"undefined"!=typeof a&&null!==a&&x.css("height",a+"px")}),c.$watch("grid.headerRowHeight",function(){i(function(){n()})}),c.headerColumnClick=function(a,b){m.enableSorting&&(m.sortAsc=m.sortColumn&&a&&m.sortColumn.field===a.field?!m.sortAsc:!0,m.sortColumn=a,"function"==typeof m.headerColumnClick?m.headerColumnClick("string"==typeof a.value?a.value:a,b,m.sortAsc):m.sortByColumn(a,m.sortAsc))};var D=0;w.addEventListener("scroll",p),t.on("click","input.check-all",function(){m.selectAll(this.checked),c.$apply()}),z.on("click",".grid-column",function(a){if(!angular.element(a.target).is("input:checkbox")){var b=angular.element(this),d=r(b);d&&(b.is(".grid-checkbox-column")?(a.stopImmediatePropagation(),m.selectItem(d,!m.isItemSelected(d))):m.rowClick&&m.rowClick(d,m._data.indexOf(d)),c.$apply())}}),z.on("click","input:checkbox",function(a){a.stopImmediatePropagation(),m.selectItem(r(angular.element(this)),this.checked),c.$apply()}),m.rowTemplateUrl||m.rowTemplate||(m.rowTemplate=e),m.rowTemplate?s(z,m.rowTemplate):b.get(m.rowTemplateUrl,{cache:f}).success(function(a){s(z,a)}),m.headerRowTemplateUrl||m.headerRowTemplate||(m.headerRowTemplate=d),m.headerRowTemplate?s(u,m.headerRowTemplate):b.get(m.headerRowTemplateUrl,{cache:f}).success(function(a){s(u,a)})}return{restrict:"A",scope:{grid:"=mfGrid"},replace:!0,controller:"MfGridCtrl",template:c,link:function(a,b,c,d){var e=a.grid||{};for(var f in e)e.hasOwnProperty(f)&&(d[f]=e[f]);a.grid=d,d.$scope=a,k(a,b,c,d)}}}]).directive("mfGridRow",[function(){return{restrict:"A",link:function(a,b){var c=a.grid;b[0].style.height=c.rowHeight+"px",a.$watch(function(){return c.itemsBefore},function(){var b=c.itemsBefore+a.$index;a.itemIndex=b,a.rowClass["grid-row-odd"]=b%2===0,a.rowClass["grid-row-even"]=b%2===1}),a.$watch(function(){return c.isItemSelected(a.item)},function(b){a.isSelected=b,a.rowClass["grid-row-selected"]=b}),a.rowClass={}}}}]).directive("mfGridColumn",[function(){return{restrict:"A",link:function(a,b){b[0].style.width=a.column.width,a.column.cellClass&&(b[0].className+=" "+a.column.cellClass),a.$watch(function(){return a.column.getFilteredValue(a.item,a.$parent)},function(a){"undefined"==typeof a&&(a=""),b[0].innerHTML=a})}}}])}();